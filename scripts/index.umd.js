!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).gcpMiniappkitJssdk=t()}(this,function(){"use strict";var e=0;function t(t){return"__private_"+e+++"_"+t}function s(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}class i{constructor(){this.stack=[]}get list(){return this.stack}add(e){this.stack=this.stack.concat(e)}clear(){this.stack.forEach(e=>{var t;return null==e||null===(t=e.destroy)||void 0===t?void 0:t.call(e)}),this.stack=[]}remove(e){this.stack=this.stack.filter(t=>t!==e)}}class o{constructor(e){this._data=e,this._id=(new Date).toISOString()+"-"+String(Math.random()).slice(2);const t=e.onCompleted;this.onCompleted=void 0===t?()=>!1:t,this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get id(){return this._id}get data(){return this._data}get promise(){return this._promise}resolve(e){this.clearTimeout(),this._resolve(e),this.onCompleted()}reject(e=""){this.clearTimeout(),this._reject(e),this.onCompleted()}setExpiration(e=(()=>!1),t=0){t&&(this.timeoutId=setTimeout(()=>{e(),this.reject({code:504,message:"timeout"})},t))}clearTimeout(){clearTimeout(this.timeoutId)}}const r="gcp-miniapp-jssdk";class n{constructor(e){this._eventListener=e=>{const t=e.detail,s=this.queue.list.filter(e=>!e.removed).find(e=>{var s,i;return"string"==typeof(null==t?void 0:t.id)?(null===(s=e.data)||void 0===s?void 0:s.id)===(null==t?void 0:t.id):(null===(i=e.data)||void 0===i?void 0:i.topic)===(null==t?void 0:t.topic)});if(s){var i;const e=null==t||null===(i=t.message)||void 0===i?void 0:i.error;e?s.reject(e):s.resolve(null==t?void 0:t.message)}},this.queue=new i,this.platform=e,this.eventListener=this._eventListener.bind(this),window.addEventListener("GCPWebViewBridge",this.eventListener)}addTaskToQueue(e,t=3e4){var s,i;const r=new o(e);return r.onCompleted=()=>{var e,t;r.removed=!0,null===(e=this.queue)||void 0===e||null===(t=e.remove)||void 0===t||t.call(e,r)},r.setExpiration(void 0,t),null===(s=this.queue)||void 0===s||null===(i=s.add)||void 0===i||i.call(s,r),r}postMessage(e){switch(this.platform){case"ios":window.webkit.messageHandlers.GCPWebViewBridge.postMessage(e);break;case"android":window.GCPWebViewBridge.postMessage(JSON.stringify(e))}}clear(){this.queue.clear()}}function a(e,t=""){if(!t)return e;if(!e)return;const s=t.split("."),i=e[s.shift()];return i?a(i,s.join(".")):void 0}function c(){return`${Date.now()}-${Math.random().toFixed(5)}`}const d={"Content-Type":"application/json"},u=new Set(["init","getAccessToken","getUserInfo","processPayment","processOrder","cancelOrder","openBrowser","setShowBackButton"]),l=e=>u.has(e),h={},p={};var m=t("platform"),g=t("messenger"),w=t("state"),v=t("get");class f{constructor(){return Object.defineProperty(this,v,{value:k}),Object.defineProperty(this,m,{writable:!0,value:void 0}),Object.defineProperty(this,g,{writable:!0,value:void 0}),Object.defineProperty(this,w,{writable:!0,value:void 0}),s(this,m)[m]=a(window,"webkit.messageHandlers.GCPWebViewBridge.postMessage")?"ios":a(window,"GCPWebViewBridge.postMessage")?"android":"web",s(this,g)[g]=new n(s(this,m)[m]),s(this,w)[w]=new WeakMap,s(this,v)[v]()}static load(){return window[r]||(window[r]=new f),window[r]}init(e="mock"){return e&&"string"==typeof e?("mock"===e&&(s(this,w)[w].set(p,!0),console.warn("Using mock as AccessToken. Don't forget to set real BundleID!")),s(this,w)[w].set(h,e),Promise.resolve(s(this,v)[v]())):Promise.reject(new Error("invalid bundleID. Use .init(bundleID) with your id or 'mock'"))}getAccessToken(){const e=s(this,w)[w].get(h),t={id:c(),topic:"GetAccessToken",message:{bundle_id:String(e)}},i=s(this,g)[g].addTaskToQueue(t);return this.useOnlyMocks()?i.resolve({token:"acess_token_mock_AAA111",isMock:!0}):s(this,g)[g].postMessage(t),i.promise}processPayment({deepLink:e,qr:t}){const i=s(this,w)[w].get(h),o={id:c(),topic:"ProcessPayment",message:{bundle_id:String(i),qr:t,deepLink:e}},r=s(this,g)[g].addTaskToQueue(o,42e4);return this.useOnlyMocks()?r.resolve({txId:"mock_tx_id_123",status:"success",isMock:!0}):s(this,g)[g].postMessage(o),r.promise}useOnlyMocks(){return!("web"!==s(this,m)[m]&&!s(this,w)[w].get(p))}getUserInfo(){const e=function(e,t={}){const s=t.headers,i=t.baseUrl,o=void 0===i?"https://miniapp-tw.omiselab.dev":i,r=function(e,t){if(null==e)return{};var s,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)t.indexOf(s=r[i])>=0||(o[s]=e[s]);return o}(t,["headers","baseUrl"]);return t=>fetch(o+e,Object.assign({method:"GET",headers:Object.assign({},d,t&&{Authorization:"Bearer "+t}||{},s||{}),credentials:"same-origin"},r)).then(e=>{const t=e.ok;if(!t)throw new Error(JSON.stringify({ok:t,status:e.status,statusText:e.statusText},void 0,2));return e.json()})}("/v1/userinfo");return this.getAccessToken().then(({token:t,isMock:s})=>s?Promise.resolve({email:"john123@example.com",first_name:"John",last_name:"Doe",isMock:!0}):e(t))}processOrder(e){if(this.useOnlyMocks())return Promise.resolve({status:"success",payment_id:"mock",response:{mock:"mock"}});const t={id:c(),topic:"ProcessOrder",message:{bundle_id:String(s(this,w)[w].get(h)),amount:String(e.amount),currency_code:e.currencyCode,purchase_data:e.purchaseData,twallet_shop_id:e.walletShopID}},i=s(this,g)[g].addTaskToQueue(t,0);return s(this,g)[g].postMessage(t),i.promise}cancelOrder(e){if(this.useOnlyMocks())return Promise.resolve({status:"success",response:{mock:"mock"}});const t={id:c(),topic:"CancelOrder",message:{bundle_id:String(s(this,w)[w].get(h)),payment_id:e.paymentID,twallet_shop_id:e.walletShopID}},i=s(this,g)[g].addTaskToQueue(t,0);return s(this,g)[g].postMessage(t),i.promise}openBrowser(e){switch(s(this,m)[m]){case"android":return void s(this,g)[g].postMessage({topic:"OpenBrowser",id:c(),message:{bundle_id:String(s(this,w)[w].get(h)),value:e}});case"ios":case"web":window.open(e)}}setShowBackButton(e){switch(s(this,m)[m]){case"android":case"ios":return void s(this,g)[g].postMessage({id:c(),topic:"ShowBackButton",message:{bundle_id:String(s(this,w)[w].get(h)),value:e}});case"web":console.warn(`setShowBackButton(${e}): Did not do anything. Only support Android/iOS.`)}}}var k=function(){return e=this,t=l,new Proxy(e,Object.freeze({get:(s,i)=>{if(t(i)){const t=s[i];return"function"==typeof t?t.bind(e):t}}}));var e,t};const _=()=>Promise.resolve(),b={get:(e,t)=>"default"===t||"__esModule"===t?new Proxy({},{get:()=>_}):_},y="undefined"!=typeof window?f.load():new Proxy({},b);return Object.freeze(y)});
