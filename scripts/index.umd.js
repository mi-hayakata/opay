!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).gcpMiniappkitJssdk={})}(this,function(e){"use strict";var t=0;function i(e){return"__private_"+t+++"_"+e}function s(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}const o=function(){function e(){}return e.prototype.then=function(t,i){const s=new e,o=this.s;if(o){const e=1&o?t:i;if(e){try{n(s,1,e(this.v))}catch(e){n(s,2,e)}return s}return this}return this.o=function(e){try{const o=e.v;1&e.s?n(s,1,t?t(o):o):i?n(s,1,i(o)):n(s,2,o)}catch(e){n(s,2,e)}},s},e}();function n(e,t,i){if(!e.s){if(i instanceof o){if(!i.s)return void(i.o=n.bind(null,e,t));1&t&&(t=i.s),i=i.v}if(i&&i.then)return void i.then(n.bind(null,e,t),n.bind(null,e,2));e.s=t,e.v=i;const s=e.o;s&&s(e)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));class r{constructor(){this.stack=[]}get list(){return this.stack}add(e){this.stack=this.stack.concat(e)}clear(){this.stack.forEach(e=>{var t;return null==e||null===(t=e.destroy)||void 0===t?void 0:t.call(e)}),this.stack=[]}remove(e){this.stack=this.stack.filter(t=>t!==e)}}class a{constructor(e){this._data=e,this._id=(new Date).toISOString()+"-"+String(Math.random()).slice(2);const t=e.onCompleted;this.onCompleted=void 0===t?()=>!1:t,this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get id(){return this._id}get data(){return this._data}get promise(){return this._promise}resolve(e){this.clearTimeout(),this._resolve(e),this.onCompleted()}reject(e=""){this.clearTimeout(),this._reject(e),this.onCompleted()}setExpiration(e=(()=>!1),t=0){t&&(this.timeoutId=setTimeout(()=>{e(),this.reject({code:504,message:"timeout"})},t))}clearTimeout(){clearTimeout(this.timeoutId)}}const l="gcp-miniapp-jssdk";class c{constructor(e){this.queue=new r,this.platform=e,window.addEventListener("GCPWebViewBridge",e=>{const t=e.detail;g("_eventListener called:"+JSON.stringify(t)),g("queue.list:"+JSON.stringify(this.queue.list));const i=this.queue.list.filter(e=>!e.removed).find(e=>{var i,s;return"string"==typeof(null==t?void 0:t.id)?(null===(i=e.data)||void 0===i?void 0:i.id)===(null==t?void 0:t.id):(null===(s=e.data)||void 0===s?void 0:s.topic)===(null==t?void 0:t.topic)});if(g("got task:"+JSON.stringify(i)),i){var s;const e=null==t||null===(s=t.message)||void 0===s?void 0:s.error;e?i.reject(e):i.resolve(null==t?void 0:t.message)}})}addTaskToQueue(e,t=3e4){var i,s;g("addTaskToQueue called");const o=new a(e);return o.onCompleted=()=>{var e,t;g("task.onCompleted called"),o.removed=!0,null===(e=this.queue)||void 0===e||null===(t=e.remove)||void 0===t||t.call(e,o)},o.setExpiration(void 0,t),null===(i=this.queue)||void 0===i||null===(s=i.add)||void 0===s||s.call(i,o),g("added queue.list:"+JSON.stringify(this.queue.list)),o}postMessage(e){switch(g("postMessage called : "+JSON.stringify(e)),this.platform){case"ios":window.webkit.messageHandlers.GCPWebViewBridge.postMessage(e);break;case"android":window.GCPWebViewBridge.postMessage(JSON.stringify(e))}}clear(){this.queue.clear()}}function d(e,t=""){if(!t)return e;if(!e)return;const i=t.split("."),s=e[i.shift()];return s?d(s,i.join(".")):void 0}const u={"Content-Type":"application/json"},h={},f={},g=e=>{const t=`[${i=new Date,`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}:${String(i.getSeconds()).padStart(2,"0")}.${String(i.getMilliseconds()).padStart(3,"0")}`}]: (SDK) ${String(e)}`;var i;const s=document.getElementById("js_debug_log");if(null==s)return;const o=s.value;let n=`${o}\n${t}`;0===o.length&&(n=t),s.value=n,s.style.height=s.clientHeight+"px",s.style.height=s.scrollHeight+"px"};var m=i("platform"),v=i("messenger"),p=i("state"),w=i("useOnlyMocks");class y{constructor(){Object.defineProperty(this,w,{value:b}),Object.defineProperty(this,m,{writable:!0,value:void 0}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,p,{writable:!0,value:void 0}),s(this,m)[m]=d(window,"webkit.messageHandlers.GCPWebViewBridge.postMessage")?"ios":d(window,"GCPWebViewBridge.postMessage")?"android":"web",s(this,v)[v]=new c(s(this,m)[m]),s(this,p)[p]=new WeakMap,console.log("build 4/26 21:22"),g("build 4/26 21:22")}static load(){return window[l]||(window[l]=new y),window[l]}init(e="mock"){return e&&"string"==typeof e?("mock"===e&&(s(this,p)[p].set(f,!0),console.warn("Using mock as AccessToken. Don't forget to set real BundleID!")),s(this,p)[p].set(h,e),Promise.resolve()):Promise.reject(new Error("invalid bundleID. Use .init(bundleID) with your id or 'mock'"))}get platform(){return s(this,m)[m]}get messenger(){return s(this,v)[v]}createMessageToNativeBase(e){const t=s(this,p)[p].get(h);return{id:`${Date.now()}-${Math.random().toFixed(5)}`,topic:e,message:{bundle_id:String(t)}}}getAccessToken(){const e=this.createMessageToNativeBase("GetAccessToken"),t=this.messenger.addTaskToQueue(e);return s(this,w)[w]()?t.resolve({token:"acess_token_mock_AAA111",isMock:!0}):this.messenger.postMessage(e),t.promise}processPayment(e){const t=e.amount,i=e.currencyCode,s=e.purchaseData,o=e.walletShopID;g("called processPayment with:"+JSON.stringify(e));const n=this.createMessageToNativeBase("ProcessPayment");n.message.amount=String(t),n.message.currency_code=i,n.message.purchase_data=s,n.message.twallet_shop_id=o,g("called msg:"+JSON.stringify(n));const r=this.messenger.addTaskToQueue(n,0);return this.messenger.postMessage(n),r.promise}getUserInfo(){const e=function(e,t={}){const i=t.headers,s=t.baseUrl,o=void 0===s?"https://miniapp-tw.omiselab.dev":s,n=function(e,t){if(null==e)return{};var i,s,o={},n=Object.keys(e);for(s=0;s<n.length;s++)t.indexOf(i=n[s])>=0||(o[i]=e[i]);return o}(t,["headers","baseUrl"]);return t=>fetch(o+e,Object.assign({method:"GET",headers:Object.assign({},u,t&&{Authorization:"Bearer "+t}||{},i||{}),credentials:"same-origin"},n)).then(e=>{const t=e.ok;if(!t)throw new Error(JSON.stringify({ok:t,status:e.status,statusText:e.statusText},void 0,2));return e.json()})}("/v1/userinfo");return this.getAccessToken().then(({token:t,isMock:i})=>i?Promise.resolve({email:"john123@example.com",first_name:"John",last_name:"Doe",isMock:!0}):e(t))}getCurrentPosition(){try{const e=this;return g('"sdk.getCurrentPosition" called'),Promise.resolve(function(e,t){var i,s=-1;e:{for(var r=0;r<t.length;r++){var a=t[r][0];if(a){var l=a();if(l&&l.then)break e;if(l===e){s=r;break}}else s=r}if(-1!==s){do{for(var c=t[s][1];!c;)s++,c=t[s][1];var d=c();if(d&&d.then){i=!0;break e}var u=t[s][2];s++}while(u&&!u());return d}}const h=new o,f=n.bind(null,h,2);return(i?d.then(g):l.then(function i(o){for(;;){if(o===e){s=r;break}if(++r===t.length){if(-1!==s)break;return void n(h,1,c)}if(a=t[r][0]){if((o=a())&&o.then)return void o.then(i).then(void 0,f)}else s=r}do{for(var l=t[s][1];!l;)s++,l=t[s][1];var c=l();if(c&&c.then)return void c.then(g).then(void 0,f);var d=t[s][2];s++}while(d&&!d());n(h,1,c)})).then(void 0,f),h;function g(e){for(;;){var i=t[s][2];if(!i||i())break;s++;for(var o=t[s][1];!o;)s++,o=t[s][1];if((e=o())&&e.then)return void e.then(g).then(void 0,f)}n(h,1,e)}}(e.platform,[[function(){return"ios"},function(){{const t=e.createMessageToNativeBase("LocationAuthorized"),i=e.messenger.addTaskToQueue(t,0);return e.messenger.postMessage(t),g("promise waiting ..."),Promise.resolve(i.promise).then(function(e){return g("promise resolved : "+e),1===e?k():void 0})}}],[function(){return"android"}],[function(){return"web"},function(){return k()}]]))}catch(e){return Promise.reject(e)}}}var b=function(){return!("web"!==s(this,m)[m]&&!s(this,p)[p].get(f))};const k=()=>new Promise(e=>{navigator.geolocation||(console.warn("Geolocation API is not supported"),e(void 0)),navigator.geolocation.getCurrentPosition(t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude})},t=>{console.warn(t),e(void 0)},{enableHighAccuracy:!1,maximumAge:6e4,timeout:3e3})}),S=()=>Promise.resolve(),P={get:(e,t)=>"default"===t||"__esModule"===t?new Proxy({},{get:()=>S}):S},_="undefined"!=typeof window?y.load():new Proxy({},P);var T=Object.freeze(_);e.SDK=y,e.default=T});
